<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis AI Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            background: linear-gradient(to bottom right, var(--bs-body-bg), var(--bs-tertiary-bg));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bs-tertiary-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Custom Scrollbar (Firefox) */
        #chatBoxContainer,
        #commandSuggestions {
            scrollbar-width: thin;
        }

        /* 輸入中...動畫特效 */
        @keyframes dots {
            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.0);
                opacity: 1;
            }
        }

        /* MARKDOWN*/
        .message-bubble.ai ul,
        .message-bubble.ai ol {
            padding-left: 1.5rem; /* 列表縮排 */
            margin-bottom: 0.5rem;
        }
        .message-bubble.ai li {
            margin-bottom: 0.25rem; /* 列表項間距 */
        }

        /* 行內程式碼樣式 */
        .message-bubble.ai code:not(pre code) {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-emphasis-color);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        /* 程式碼區塊樣式 */
        .message-bubble.ai pre {
            background-color: var(--bs-tertiary-bg);
            color: var(--bs-emphasis-color);
            padding: 0.75rem;
            border-radius: var(--bs-border-radius);
            overflow-x: auto; /* 允許水平捲動 */
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            white-space: pre; /* 保留空白和換行 */
        }

        /* 程式碼區塊內的 code 標籤樣式重置 */
        .message-bubble.ai pre code {
            background-color: transparent;
            padding: 0;
            font-size: inherit;
            white-space: inherit;
        }

        /* 區塊引言樣式 */
        .message-bubble.ai blockquote {
            border-left: 3px solid var(--bs-border-color);
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 0.5rem;
            color: var(--bs-secondary-color);
        }

        .message-bubble.ai h1, .message-bubble.ai h2, .message-bubble.ai h3,
        .message-bubble.ai h4, .message-bubble.ai h5, .message-bubble.ai h6 {
            margin-top: 0.8rem;
            margin-bottom: 0.4rem;
            font-weight: 600;
            line-height: 1.3;
        }
        .message-bubble.ai h1 { font-size: 1.4rem; }
        .message-bubble.ai h2 { font-size: 1.2rem; }
        .message-bubble.ai h3 { font-size: 1.1rem; }

        .message-bubble.ai p {
            margin-bottom: 0.5rem;
        }
        .message-bubble.ai p:last-child {
            margin-bottom: 0;
        }

        .message-bubble.ai table {
            width: 100%;
            margin-bottom: 1rem;
            color: var(--bs-emphasis-color);
            border-color: var(--bs-border-color);
            border-collapse: collapse;
        }
        .message-bubble.ai th,
        .message-bubble.ai td {
            padding: 0.5rem 0.5rem;
            border: 1px solid var(--bs-border-color);
        }
        .message-bubble.ai thead th {
            vertical-align: bottom;
            border-bottom: 2px solid var(--bs-border-color);
            background-color: var(--bs-tertiary-bg);
        }
        .message-bubble.ai tbody tr:nth-of-type(odd) {
            /* 斑馬紋效果 */
            background-color: var(--bs-tertiary-bg-rgb, rgba(var(--bs-tertiary-bg-rgb), 0.05));
        }


        .typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 2px;
            background: var(--bs-secondary-color);
            border-radius: 50%;
            animation: dots 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0;
        }

        @keyframes rgb-glow {
            0% {
                box-shadow: 0 0 9px 3px #ff0080aa;
            }

            25% {
                box-shadow: 0 0 9px 3px #ff8c00aa;
            }

            50% {
                box-shadow: 0 0 9px 3px #40e0d0aa;
            }

            75% {
                box-shadow: 0 0 9px 3px #8a2be2aa;
            }

            100% {
                box-shadow: 0 0 9px 3px #ff0080aa;
            }
        }

        .input-group-glow {
            position: relative;
            border-radius: var(--bs-border-radius-lg);
            transition: box-shadow 0.3s ease-in-out;
            z-index: 1;
        }

        .input-group-glow::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: inherit;
            animation: rgb-glow 3s ease-in-out infinite;
            z-index: -1;
            pointer-events: none;
        }

        .input-group-glow>.form-control {
            border: none;
            box-shadow: none !important;
        }

        .input-group-glow>.form-control:focus {
            box-shadow: none !important;
            border-color: transparent;
            z-index: 3;
        }

        .fs-sm {
            font-size: 0.8rem;
        }

        .input-group.input-group-lg > .form-control:not(:last-child) {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-group.input-group-lg > .btn.btn-primary {
            border-radius: var(--bs-border-radius-lg);
            position: relative;
            z-index: 0;
            transition: background-color 0.3s ease-in-out,
                        color 0.3s ease-in-out;
            border: none;
        }

        html[data-bs-theme="light"] .input-group.input-group-lg > .btn.btn-primary {
            background-color: #ffffff;
            color: #000000;
        }

        html[data-bs-theme="light"] .input-group.input-group-lg > .btn.btn-primary:hover {
            background-color: #000000;
            color: #ffffff;
            z-index: 1;
        }

        html[data-bs-theme="dark"] .input-group.input-group-lg > .btn.btn-primary {
            background-color: #212529;
            color: #ffffff;
        }

        html[data-bs-theme="dark"] .input-group.input-group-lg > .btn.btn-primary:hover {
            background-color: #ffffff;
            color: #000000;
            z-index: 1;
        }

        .input-group.input-group-lg > .btn.btn-primary:focus {
            box-shadow: none;
            z-index: 1;
        }

        #chatBoxContainer {
            height: calc(100vh - 350px);
            min-height: 300px;
            max-height: 55vh;
            overflow-y: auto;
            background-color: var(--bs-body-tertiary);
            border-radius: var(--bs-card-border-radius);
            padding: 1rem;
            scroll-behavior: smooth;
        }

        #inputAreaWrapper {
            position: relative;
        }

        #commandSuggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
            border-radius: var(--bs-border-radius);
            background-color: var(--bs-body-bg);
        }

        #commandSuggestions .list-group-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-color: var(--bs-border-color-translucent);
        }

        #commandSuggestions .list-group-item small {
            font-size: 0.75rem;
            opacity: 0.8;
            color: var(--bs-secondary-color);
        }

        #commandSuggestions .list-group-item.active {
            z-index: 2;
        }

        #userInput::placeholder {
            font-size: 0.9rem;
            color: #888;
        }

        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }

        .message-bubble.user {
            background-color: var(--bs-primary);
            color: var(--bs-primary-bg-subtle);
            border-bottom-right-radius: 0 !important;
        }

        .message-bubble.ai,
        .message-bubble.system {
            background-color: var(--bs-secondary-bg-subtle);
            color: var(--bs-emphasis-color);
            border-bottom-left-radius: 0 !important;
        }

        .message-bubble .sender {
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }

        .message-bubble .timestamp {
            font-size: 0.75rem;
            margin-top: 0.3rem;
            opacity: 0.7;
        }

        .avatar {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
            object-fit: cover;
        }

        #theme-toggler {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
        }

        .input-group .btn {
            height: 100%;
        }

        .input-group-glow>.btn {
            z-index: 2;
        }

        .input-group-glow>.btn:focus {
            box-shadow: none;
        }


        /* RWD 還要再調整 */
        @media (max-width: 767.98px) {
            #chatBoxContainer {
                height: calc(100vh - 310px);
                max-height: 60vh;
            }

            h1 {
                font-size: 1.75rem;
            }

            .form-control-lg {
                font-size: 1rem;
            }

            .btn-lg {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Theme Toggle Btn -->
    <button id="theme-toggler" class="btn btn-outline-secondary rounded-circle p-2 lh-1 shadow-sm"
        aria-label="Toggle theme">
        <i class="bi bi-sun-fill"></i>
    </button>

    <div class="container mt-5 mb-4 flex-grow-1">
        <div class="row justify-content-center">
            <div class="col-xl-7 col-lg-8 col-md-10 col-12">

                <header class="text-center mb-4">
                    <h1 class="fw-bold">Financial Analysis AI Agent</h1>
                    <p class="text-muted lead">Ask me about financial data, trends, or analysis.</p>
                </header>

                <!-- Chat Box Container -->
                <div id="chatBoxContainer" class="shadow-sm mb-3">
                    <div id="chatBoxContent"></div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing" class="text-muted fs-sm mb-2 d-none align-items-center ps-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-robot me-1" viewBox="0 0 16 16">
                        <path
                            d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.219zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a25 25 0 0 1-1.871-.183.25.25 0 0 0-.068.217c.156.417.833.939 2.831.939s2.675-.522 2.831-.939a.25.25 0 0 0-.068-.217 25 25 0 0 1-1.87-.183l-.92-.9a.25.25 0 0 0-.217-.068Z" />
                        <path
                            d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1M1 8a7 7 0 0 1 7-7h.07A6.96 6.96 0 0 1 15 8v.07A6.96 6.96 0 0 1 8.07 15H8a7 7 0 0 1-7-7m4-2.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m7 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0M5.07 11.965a.5.5 0 0 0 .707.707l1.73-1.73a.5.5 0 0 0-.707-.707l-1.73 1.73Zm5.16 0a.5.5 0 0 1-.707.707l-1.73-1.73a.5.5 0 1 1 .707-.707l1.73 1.73Z" />
                    </svg>
                    AI is typing<span class="typing-dots ms-1"><span></span><span></span><span></span></span>
                </div>

                <!-- Input Area Wrapper -->
                <div id="inputAreaWrapper">
                    <!-- cmd Suggestions Box -->
                    <div id="commandSuggestions" class="list-group shadow-sm d-none"></div>

                    <div class="input-group input-group-lg shadow-sm input-group-glow">
                        <input id="userInput" type="text" placeholder="Type message or / for commands..."
                            class="form-control" aria-label="User message input" autocomplete="off">
                        <button onclick="sendMessage()" class="btn btn-primary" type="button" aria-label="Send message">
                            <i class="bi bi-send-fill"></i>
                            <span class="d-none d-sm-inline ms-1">Send</span>
                            <small class="opacity-75 d-none d-md-block mt-1"
                                style="font-size: 0.8rem; line-height: 1;">(Ctrl+Enter)</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-auto py-3 text-muted fs-sm border-top"
        style="background-color: var(--bs-tertiary-bg);">
        © <span id="current-year"></span> Tai Ming Chen, NCUE CSIE. All rights reserved. <br>
        Powered by Gemini 2.0 pro. <span class="d-none d-lg-inline">| Interface built with Bootstrap.</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"
        integrity="sha512-5g2Nj3mqLOgClHi20oat1COW7jWvf7SyqnvwWUsMDwhjHeqeTl0C+uzjucLweruQxHbhDwiPLXlm8HBO0011pA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>

    <script>

        // --- DOM Elements ---
        const chatBoxContainer = document.getElementById("chatBoxContainer");
        const chatBoxContent = document.getElementById("chatBoxContent");
        const typing = document.getElementById("typing");
        const userInput = document.getElementById("userInput");
        const htmlElement = document.documentElement;
        const themeToggler = document.getElementById('theme-toggler');
        const themeIcon = themeToggler.querySelector('i');
        const currentYearSpan = document.getElementById('current-year');
        const commandSuggestions = document.getElementById('commandSuggestions');

        // --- Constants & State ---
        const LOCAL_STORAGE_KEY = 'themePreferenceFinAgent';
        const N8N_WEBHOOK_URL = "https://mingcc.app.n8n.cloud/webhook/ac662654-0156-44d6-ad50-c68e7a7a2355";
        const commands = [
            { name: "/help", description: "Show commands list" },
            { name: "/clear", description: "Clear the chat history" },
            { name: "/theme", description: "Toggle light/dark theme" },
            { name: "/memory", description: "Let LLM memory this msg (施工中...)" },
            { name: "/settings", description: "Adjust AI settings (施工中...)" },
        ];
        let selectedSuggestionIndex = -1;
        let blurTimeout;

        // --- 版權聲明使用 ---
        currentYearSpan.textContent = new Date().getFullYear();

        // --- Theme Management ---
        function getPreferredTheme() { return localStorage.getItem(LOCAL_STORAGE_KEY) || 'light'; }
        function applyTheme(theme) {
            htmlElement.setAttribute('data-bs-theme', theme);
            themeIcon.classList.replace(theme === 'dark' ? 'bi-sun-fill' : 'bi-moon-stars-fill', theme === 'dark' ? 'bi-moon-stars-fill' : 'bi-sun-fill');
            themeToggler.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
            updateScrollbarColors();
        }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem(LOCAL_STORAGE_KEY, theme); }
        function updateScrollbarColors() {
            try {
                const trackColor = getComputedStyle(chatBoxContainer).getPropertyValue('background-color');
                const thumbColor = '#888';
                const scrollbarStyle = `${thumbColor} ${trackColor}`;
                chatBoxContainer.style.scrollbarColor = scrollbarStyle;
                commandSuggestions.style.scrollbarColor = scrollbarStyle;
            } catch (error) { console.warn("Could not update scrollbar colors:", error); }
        }
        const initialTheme = getPreferredTheme();
        applyTheme(initialTheme);
        themeToggler.addEventListener('click', () => setTheme(htmlElement.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light'));


        // --- Command Suggestion Logic ---
        function handleInputCommand() {
            const value = userInput.value;
            if (value.startsWith('/')) {
                const searchTerm = value.substring(1).toLowerCase();
                const filteredCommands = commands.filter(cmd => cmd.name.substring(1).toLowerCase().startsWith(searchTerm));
                if (filteredCommands.length > 0) { showSuggestions(filteredCommands); }
                else { hideSuggestions(); }
            } else { hideSuggestions(); }
        }
        function showSuggestions(filteredCommands) {
            commandSuggestions.innerHTML = ''; selectedSuggestionIndex = -1;
            filteredCommands.forEach((cmd) => {
                const item = document.createElement('a'); item.href = "#";
                item.classList.add('list-group-item', 'list-group-item-action');
                item.innerHTML = `<strong>${cmd.name}</strong><br><small>${cmd.description}</small>`;
                item.dataset.command = cmd.name;
                item.addEventListener('mousedown', (e) => { e.preventDefault(); selectSuggestion(cmd.name); });
                item.onclick = (e) => e.preventDefault();
                commandSuggestions.appendChild(item);
            });
            commandSuggestions.classList.remove('d-none'); updateScrollbarColors();
        }
        function hideSuggestions() {
            if (!commandSuggestions.classList.contains('d-none')) {
                commandSuggestions.classList.add('d-none');
                commandSuggestions.innerHTML = ''; selectedSuggestionIndex = -1;
            }
        }
        function selectSuggestion(commandName) {
            userInput.value = commandName;
            hideSuggestions();
            userInput.focus();
        }
        function highlightSuggestion(index) {
            const items = commandSuggestions.querySelectorAll('.list-group-item'); if (items.length === 0) return;
            items[selectedSuggestionIndex]?.classList.remove('active'); // Null check
            selectedSuggestionIndex = index;
            items[selectedSuggestionIndex]?.classList.add('active'); // Null check
            items[selectedSuggestionIndex]?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }

        // --- Chat Logic ---
        function handleLocalCommand(command) {
            let handled = true;
            const trimmedCommand = command.trim();

            switch (command.trim()) {
                case '/clear':
                    chatBoxContent.innerHTML = '';
                    appendMessage("You", command, "user");
                    appendMessage("System", "Chat history cleared.", "system");
                    break;
                case '/help':
                    const helpText = commands.map(cmd => `<strong>${cmd.name}</strong>: ${cmd.description}`).join('<br>');
                    appendMessage("You", command, "user");
                    appendMessage("System", `Available commands:<br>${helpText}`, "system");
                    break;
                case '/theme':
                    const currentTheme = htmlElement.getAttribute('data-bs-theme'); 
                    setTheme(currentTheme === 'light' ? 'dark' : 'light');
                    appendMessage("You", command, "user");
                    appendMessage("System", `Theme switched to ${currentTheme === 'light' ? 'dark' : 'light'}.`, "system");
                    break;
                default:
                    handled = false;
                    break;
            }
            return handled;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            hideSuggestions();

            if (handleLocalCommand(message)) {
                userInput.value = "";
                return;
            }

            if (N8N_WEBHOOK_URL === "YOUR_N8N_WEBHOOK_URL_HERE") {
                appendMessage("System", "⚠️ Error: n8n webhook URL not configured.", "system");
                return;
            }

            appendMessage("You", message, "user");
            userInput.value = "";

            userInput.disabled = true;
            typing.classList.remove("d-none");
            typing.classList.add("d-flex");

            try { // Fetch logic
                const res = await fetch(N8N_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ query: message }) });
                if (!res.ok) { let errorMsg = `HTTP error! Status: ${res.status} ${res.statusText}`; try { const errorData = await res.json(); errorMsg += ` - ${errorData.message || JSON.stringify(errorData)}`; } catch (e) { } throw new Error(errorMsg); }
                const data = await res.json();
                let replyText = data?.reply || data?.message || (typeof data === 'string' ? data : null);
                if (replyText !== null) {
                    appendMessage("AI", replyText, "ai");
                } else { console.error("AI response format unexpected:", data); appendMessage("System", "⚠️ AI response format error.", "system"); }
            } catch (err) { // Error handling
                console.error("Error sending/receiving message:", err);
                let displayError = "⚠️ Failed to communicate with the AI agent.";
                if (err.message?.includes("Failed to fetch")) {
                    displayError += " Check network connection or webhook URL.";
                }
                else if (err.message) {
                    displayError += ` Details: ${err.message.split('-')[0]}`;
                }
                appendMessage("System", displayError, "system");
            } finally {
                typing.classList.add("d-none");
                typing.classList.remove("d-flex");
                userInput.disabled = false;
                userInput.focus();
            }
        }

        function appendMessage(sender, text, type = "ai") {
            const messageWrapper = document.createElement("div");
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isUser = type === "user";
            const senderInitial = sender === "System" ? "S" : (sender === "AI" ? "A" : "Y");
            const avatarBg = isUser ? 'bg-info' : (type === 'system' ? 'bg-warning' : 'bg-secondary');
            const avatar_1 = `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"> ${senderInitial} </div>`;
            const avatar_2 = `<img src="img.jpg" alt="${sender} Avatar" class="avatar rounded-circle">`;
            const bubbleClasses = `p-3 rounded shadow-sm message-bubble ${type}`;
            const textAlignment = isUser ? 'text-end' : 'text-start';
            const timeAlignment = isUser ? 'text-end' : 'text-start';

            let formattedText;

            // --- 修改開始 ---
            if (type === 'ai') {
                // 1. 使用 marked 將 AI 的 Markdown 文本轉換為 HTML
                //    gfm: true 啟用 GitHub Flavored Markdown (例如表格、刪除線)
                //    breaks: true 將單個換行符視為 <br> (可選，依需求決定)
                const rawHtml = marked.parse(text, { gfm: true, breaks: true });
                // 2. 使用 DOMPurify 清理生成的 HTML 以防止 XSS 攻擊
                formattedText = DOMPurify.sanitize(rawHtml);
            } else {
                // 對於使用者和系統訊息，進行 HTML 特殊字符轉義，並將換行符替換為 <br>
                formattedText = text.replace(/&/g, '&')
                                .replace(/</g, '<')
                                .replace(/>/g, '>')
                                .replace(/"/g, '"')
                                .replace(/'/g, "'");
                // 在轉義完畢後，再處理換行符
                formattedText = formattedText.replace(/\n/g, "<br>");
            }
            // const messageWrapper = document.createElement("div");
            // const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            // const isUser = type === "user";
            // const senderInitial = sender === "System" ? "S" : (sender === "AI" ? "A" : "Y");
            // const avatarBg = isUser ? 'bg-info' : (type === 'system' ? 'bg-warning' : 'bg-secondary');
            // const avatar_1 = `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center fw-bold"> ${senderInitial} </div>`;    // 字母頭貼 for User
            // const avatar_2 = `<img src="img.jpg" alt="${sender} Avatar" class="avatar rounded-circle">`;  // 圖片頭貼 for AI Agent
            // const bubbleClasses = `p-3 rounded shadow-sm message-bubble ${type}`;
            // const textAlignment = isUser ? 'text-end' : 'text-start';
            // const timeAlignment = isUser ? 'text-end' : 'text-start';
            // let formattedText = text.replace(/\n/g, "<br>");
            // if (isUser) {   // Sanitize user text
            //     formattedText = formattedText.replace(/</g, "<").replace(/>/g, ">");
            // }


            const messageBox = `<div class="${bubbleClasses}"><div class="sender ${textAlignment}">${sender}</div><div class="${textAlignment}">${formattedText}</div><div class="timestamp ${timeAlignment}">${timestamp}</div></div>`;
            messageWrapper.className = `d-flex align-items-end mb-3 ${isUser ? "justify-content-end" : "justify-content-start"}`;
            const marginClass = isUser ? 'ms-2' : 'me-2';
            messageWrapper.innerHTML = isUser ? `<div class="flex-grow-1 d-flex justify-content-end">${messageBox}</div> <div class="${marginClass}">${avatar_1}</div>` : `<div class="${marginClass}">${avatar_2}</div> <div class="flex-grow-1">${messageBox}</div>`;
            chatBoxContent.appendChild(messageWrapper);
            scrollToBottom();
        }

        function scrollToBottom() { chatBoxContainer.scrollTo({ top: chatBoxContainer.scrollHeight, behavior: 'smooth' }); }

        // --- Event Listeners & Initial Actions ---
        userInput.addEventListener('input', handleInputCommand);
        userInput.addEventListener('keydown', (e) => {
            const suggestionsVisible = !commandSuggestions.classList.contains('d-none');
            if (suggestionsVisible) {
                const items = commandSuggestions.querySelectorAll('.list-group-item');
                if (items.length > 0) {
                    let handled = false;
                    switch (e.key) {
                        case 'ArrowDown': highlightSuggestion((selectedSuggestionIndex + 1) % items.length);
                            handled = true;
                            break;
                        case 'ArrowUp':
                            highlightSuggestion((selectedSuggestionIndex - 1 + items.length) % items.length);
                            handled = true;
                            break;
                        case 'Enter':
                        case 'Tab':
                            if (selectedSuggestionIndex >= 0) {
                                selectSuggestion(items[selectedSuggestionIndex].dataset.command);
                                handled = true;
                            }
                            else {
                                hideSuggestions();
                            }
                            break;
                        case 'Escape':
                            hideSuggestions();
                            handled = true;
                            break;
                    }
                    if (handled) {e.preventDefault(); return; }
                }
            }
            if (e.ctrlKey && e.key === "Enter") { e.preventDefault(); sendMessage(); }
        });
        userInput.addEventListener('blur', () => { blurTimeout = setTimeout(hideSuggestions, 150); });
        userInput.addEventListener('focus', () => { clearTimeout(blurTimeout); });

        // Initial setup
        userInput.focus();
        appendMessage("AI", "支援 markdown 格式，可以試試看魔術指令: /help ", "ai");
        updateScrollbarColors();

    </script>
</body>

</html>
